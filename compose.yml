# =============================================================================
# HIRING SERVICE - DOCKER COMPOSE
# =============================================================================
# Variables loaded from:
#   .env.app   - application config (hosts, ports, credentials)
#   .env.infra - infrastructure config (container names, external ports)
# Run: make up
# =============================================================================

services:
  # ===========================================================================
  # APPLICATION SERVICES
  # ===========================================================================
  api:
    build:
      context: .
      dockerfile: builds/Dockerfile
      target: api
    container_name: hiring_api
    env_file:
      - .env.app
    ports:
      - "${APP_PORT}:8080"
    depends_on:
      postgres_primary:
        condition: service_healthy
      postgres_replica:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - backend
    restart: unless-stopped

  worker:
    build:
      context: .
      dockerfile: builds/Dockerfile
      target: worker
    container_name: hiring_worker
    env_file:
      - .env.app
    depends_on:
      postgres_primary:
        condition: service_healthy
      postgres_replica:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - backend
    restart: unless-stopped

  # ===========================================================================
  # POSTGRESQL PRIMARY (WRITE)
  # ===========================================================================
  postgres_primary:
    image: postgres:16-alpine
    container_name: ${POSTGRES_PRIMARY_CONTAINER_NAME}
    environment:
      # Superuser (for init scripts and administration)
      POSTGRES_USER: ${POSTGRES_SUPERUSER}
      POSTGRES_PASSWORD: ${POSTGRES_SUPERUSER_PASSWORD}
      POSTGRES_DB: ${POSTGRES_WRITE_DB}
      # Application users (used in init.sh)
      APP_WRITE_USER: ${POSTGRES_WRITE_USERNAME}
      APP_WRITE_PASSWORD: ${POSTGRES_WRITE_PASSWORD}
      APP_READ_USER: ${POSTGRES_READ_USERNAME}
      APP_READ_PASSWORD: ${POSTGRES_READ_PASSWORD}
      # Replication user
      REPLICATOR_USER: ${POSTGRES_REPLICATOR_USERNAME}
      REPLICATOR_PASSWORD: ${POSTGRES_REPLICATOR_PASSWORD}
    ports:
      - "${POSTGRES_PRIMARY_EXTERNAL_PORT}:5432"
    volumes:
      - postgres_primary_data:/var/lib/postgresql/data
      - ./builds/local/postgres/primary/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./builds/local/postgres/primary/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
      - ./scripts/init/postgres-primary-init.sh:/docker-entrypoint-initdb.d/init.sh:ro
    command: postgres -c config_file=/etc/postgresql/postgresql.conf -c hba_file=/etc/postgresql/pg_hba.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_SUPERUSER} -d ${POSTGRES_WRITE_DB}"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      backend:
        aliases:
          - ${POSTGRES_WRITE_HOST}

  # ===========================================================================
  # POSTGRESQL REPLICA (READ)
  # ===========================================================================
  postgres_replica:
    image: postgres:16-alpine
    container_name: ${POSTGRES_REPLICA_CONTAINER_NAME}
    user: root
    environment:
      PGUSER: ${POSTGRES_SUPERUSER}
      PGPASSWORD: ${POSTGRES_SUPERUSER_PASSWORD}
      PGDATABASE: ${POSTGRES_READ_DB}
      REPLICATOR_USER: ${POSTGRES_REPLICATOR_USERNAME}
      REPLICATOR_PASSWORD: ${POSTGRES_REPLICATOR_PASSWORD}
      PRIMARY_HOST: postgres_primary
    ports:
      - "${POSTGRES_REPLICA_EXTERNAL_PORT}:5432"
    volumes:
      - postgres_replica_data:/var/lib/postgresql/data
      - ./builds/local/postgres/replica/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./builds/local/postgres/replica/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
      - ./scripts/init/postgres-replica-init.sh:/usr/local/bin/replica-init.sh:ro
    command: ["/bin/bash", "/usr/local/bin/replica-init.sh"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_SUPERUSER} && psql -U ${POSTGRES_SUPERUSER} -d ${POSTGRES_READ_DB} -c 'SELECT pg_is_in_recovery()' | grep -q t"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s
    depends_on:
      postgres_primary:
        condition: service_healthy
    networks:
      backend:
        aliases:
          - ${POSTGRES_READ_HOST}

  # ===========================================================================
  # REDIS
  # ===========================================================================
  redis:
    image: redis:7.4-alpine
    container_name: ${REDIS_CONTAINER_NAME}
    ports:
      - "${REDIS_EXTERNAL_PORT}:6379"
    volumes:
      - redis_data:/data
      - ./builds/local/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf --requirepass ${REDIS_PASSWORD}
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      backend:
        aliases:
          - ${REDIS_HOST}

  # ===========================================================================
  # RABBITMQ
  # ===========================================================================
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: ${RABBITMQ_CONTAINER_NAME}
    hostname: ${RABBITMQ_HOSTNAME}
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USERNAME}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_VHOST}
    ports:
      - "${RABBITMQ_EXTERNAL_PORT}:5672"
      - "${RABBITMQ_MANAGEMENT_PORT}:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - ./builds/local/rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      backend:
        aliases:
          - ${RABBITMQ_HOST}

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  postgres_primary_data:
  postgres_replica_data:
  redis_data:
  rabbitmq_data:

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  backend:
    driver: bridge